<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Writing a py3bar module to display MQTT temperature data - James Leighton</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://semaj.omg.lol/2020/08/writing-a-py3bar-module-to-display-mqtt-temperature-data/">

        <meta name="author" content="jamesleighton" />
        <meta name="keywords" content="linux" />
        <meta name="description" content="I recently started using the [i3 Window manager](https://i3wm.org/) and have swapped the bar from the standard bar to py3bar as it is easily extendible using python scripts and is also fully compatible with your existing i3bar configuration. You can swap to it with one change of your â€¦" />

        <meta property="og:site_name" content="James Leighton" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Writing a py3bar module to display MQTT temperature data"/>
        <meta property="og:url" content="https://semaj.omg.lol/2020/08/writing-a-py3bar-module-to-display-mqtt-temperature-data/"/>
        <meta property="og:description" content="I recently started using the [i3 Window manager](https://i3wm.org/) and have swapped the bar from the standard bar to py3bar as it is easily extendible using python scripts and is also fully compatible with your existing i3bar configuration. You can swap to it with one change of your â€¦"/>
        <meta property="article:published_time" content="2020-08-30" />
            <meta property="article:section" content="projects" />
            <meta property="article:tag" content="linux" />
            <meta property="article:author" content="jamesleighton" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://semaj.omg.lol/theme/css/bootstrap.united.min.css" type="text/css"/>
    <link href="https://semaj.omg.lol/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://semaj.omg.lol/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://semaj.omg.lol/theme/css/style.css" type="text/css"/>

        <link href="https://semaj.omg.lol/atom.xml" type="application/atom+xml" rel="alternate"
              title="James Leighton ATOM Feed"/>
    <link href="https://semaj.omg.lol/theme/css/comments.css" rel="stylesheet">
        <link href="https://semaj.omg.lol/feed/index.xml" type="application/rss+xml" rel="alternate"
              title="James Leighton RSS Feed"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://semaj.omg.lol/" class="navbar-brand">
James Leighton            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://semaj.omg.lol/category/now.html">/Now</a></li>
                    <li><a href="https://semaj.omg.lol/category/adventures.html">Adventures</a></li>
                    <li><a href="https://social.lol/@semaj">Mastodon</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://semaj.omg.lol/2020/08/writing-a-py3bar-module-to-display-mqtt-temperature-data/"
                       rel="bookmark"
                       title="Permalink to Writing a py3bar module to display MQTT temperature data">
                        Writing a py3bar module to display MQTT temperature data
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
       </i><time datetime="2020-08-30T21:35:00+01:00"> Sun 30 August 2020</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://semaj.omg.lol/category/projects.html">projects</a>


<span class="label label-default">Tags</span>
	<a href="https://semaj.omg.lol/tag/linux.html">linux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I recently started using the [i3 Window manager](https://i3wm.org/) and have swapped the bar from the standard bar to py3bar as it is easily extendible using python scripts and is also fully compatible with your existing i3bar configuration. You can swap to it with one change of your i3config and it will just work.</p>
<p>The i3 status bar is a great place to show useful information and I thought it would be handy to show the temperature of my living room which is stored in MQTT at Adafruit.io. The logic is split into two parts: The first retrieves the temperature from the MQTT server and spits it out into a text file and the second part is the py3bar module that renders the temperature to the bar.</p>
<p>

<figure>
<img src="/images/2020/08/ea99e-8347f040ab.png" class="alignnone size-full wp-image-1779" width="656" height="340" alt="Temperature Data on my i3 Bar" />
<figcaption aria-hidden="true">Temperature Data on my i3 Bar</figcaption>
</figure>

</p>

<p>Start by reading their documentation on [creating custom modules](https://py3status.readthedocs.io/en/latest/writing_modules.html) as it goes into more details about the required file paths, and has a sample 'Hello World' module to try out as well.</p>
<p>I think this could easily be extended to control smart lights or plugs and other IOT things as well. Python in the system bar is neat. ðŸ¤“</p>
<h2>Part 1 - fetch-temperature.py</h2>
<p>This script is launched at login by i3 by adding this to your i3config:</p>
<p>```bash<br>
exec --no-startup-id python3 /home/user/path/to/fetch-temperature.py &amp;<br>
```</p>
<p>The python code is fairly simple and only relies on [paho-mqtt](https://pypi.org/project/paho-mqtt/). It reads out the data and stores it in a plain text file under .config (to keep things tidy)</p>
<p>```python<br>
import paho.mqtt.client as mqtt<br>
import paho.mqtt.subscribe as subscribe</p>
<p>def on_connect(client, userdata, flags, rc):<br>
print("Connected with result code "+str(rc))<br>
client.subscribe("mqtt/feed/here")</p>
<p>def on_message_print(client, userdata, message):<br>
temp = message.payload<br>
temp = temp.decode("utf-8")<br>
#print("%s" % ( temp))</p>
<p>f = open("/home/james/.config/temperature.txt", "w")<br>
f.write(temp)<br>
f.close()</p>
<p>client = mqtt.Client()<br>
client.username_pw_set(username="username",password="adafruitio_api_key")<br>
client.connect("io.adafruit.com",1883,60)</p>
<p>client.on_connect = on_connect<br>
client.on_message = on_message_print</p>
<p>client.loop_forever()<br>
```</p>
<h2>Part 2 - Py3Bar Module</h2>
<p>This is the py3bar module and deals with displaying the temperature on the bar itself. It reads in the temperature.txt, converts it to a number, rounds it and converts it back to a string ready to print to the bar.</p>
<p>When data is found it will expire in 300 seconds and when data is not found it will expire and refresh in 15 seconds. My sensor posts to MQTT every 5 minutes so this works well. The only time that the file does not exist is on first run or when it is manually deleted. If this happens the bar will check every 15 seconds waiting for a new file to be created by the script in Part 1.</p>
<p>I should probably add some more error checking here in case the file contains things other than a simple number.</p>
<p>```python<br>
class Py3status:<br>
def flat_temperature(self):<br>
while True:<br>
try:<br>
#open and read the file after the appending:<br>
f = open("/home/james/.config/temperature.txt", "r")<br>
temp = f.read()<br>
temp = float(temp)<br>
temp = round(temp, 2)<br>
temp = str(temp)<br>
return {<br>
'full_text': temp,<br>
'cached_until': self.py3.time_in(300)<br>
}<br>
except IOError:<br>
return {<br>
'full_text': "Waiting for data",<br>
'cached_until': self.py3.time_in(15)<br>
}<br>
```</p>
            </div>
            <!-- /.entry-content -->

            <!-- No Comments -->



            





        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/04/Pontcysyllte-Aqueduct-Canal-World-Heritage-Site/">Pontcysyllte Aqueduct & Canal World Heritage Site</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/now/2024/w13/index.html">Now - Week 13 of 2024</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/03/kinver-edge-and-the-rock-houses/">Kinver Edge and the Rock Houses</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/03/thoughts-on-activitypub-and-the-fediverse/">Thoughts on ActivityPub and the Fediverse</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/02/visiting-the-highest-waterfall-in-south-wales/">Visiting the Highest Waterfall in South Wales</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="https://social.lol/@semaj" target="_blank">Mastodon</a>
    </li>
    <li class="list-group-item">
      <a href="https://ramblingreaders.org/user/Semaj" target="_blank">BookWyrm</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.exophase.com/user/geekyjames/" target="_blank">Exophase</a>
    </li>
    <li class="list-group-item">
      <a href="https://boardgamegeek.com/user/james__" target="_blank">BoardGameGeek </a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 James Leighton
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://semaj.omg.lol/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://semaj.omg.lol/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://semaj.omg.lol/theme/js/respond.min.js"></script>





<script data-goatcounter="https://semaj.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

</body>
</html>