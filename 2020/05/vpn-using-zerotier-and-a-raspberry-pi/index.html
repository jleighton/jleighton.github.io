<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Setup a VPN using Zerotier and a Raspberry Pi - James Leighton</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://semaj.omg.lol/2020/05/vpn-using-zerotier-and-a-raspberry-pi/">

        <meta name="author" content="jamesleighton" />
        <meta name="keywords" content="Projects,Networking" />
        <meta name="description" content="This post aims to document a project that I setup and use every day. It is primarily to help me in the future when I want to set it up again! I hope you find it useful for your own projects. I run a [Pihole](https://pi-hole.net/) ad blocker …" />

        <meta property="og:site_name" content="James Leighton" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Setup a VPN using Zerotier and a Raspberry Pi"/>
        <meta property="og:url" content="https://semaj.omg.lol/2020/05/vpn-using-zerotier-and-a-raspberry-pi/"/>
        <meta property="og:description" content="This post aims to document a project that I setup and use every day. It is primarily to help me in the future when I want to set it up again! I hope you find it useful for your own projects. I run a [Pihole](https://pi-hole.net/) ad blocker …"/>
        <meta property="article:published_time" content="2020-05-16" />
            <meta property="article:section" content="How To" />
            <meta property="article:tag" content="Projects" />
            <meta property="article:tag" content="Networking" />
            <meta property="article:author" content="jamesleighton" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://semaj.omg.lol/theme/css/bootstrap.united.min.css" type="text/css"/>
    <link href="https://semaj.omg.lol/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://semaj.omg.lol/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://semaj.omg.lol/theme/css/style.css" type="text/css"/>

        <link href="https://semaj.omg.lol/atom.xml" type="application/atom+xml" rel="alternate"
              title="James Leighton ATOM Feed"/>
    <link href="https://semaj.omg.lol/theme/css/comments.css" rel="stylesheet">
        <link href="https://semaj.omg.lol/feed/index.xml" type="application/rss+xml" rel="alternate"
              title="James Leighton RSS Feed"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://semaj.omg.lol/" class="navbar-brand">
James Leighton            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://semaj.omg.lol/category/now.html">/Now</a></li>
                    <li><a href="https://semaj.omg.lol/category/adventures.html">Adventures</a></li>
                    <li><a href="https://social.lol/@semaj">Mastodon</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://semaj.omg.lol/2020/05/vpn-using-zerotier-and-a-raspberry-pi/"
                       rel="bookmark"
                       title="Permalink to Setup a VPN using Zerotier and a Raspberry Pi">
                        Setup a VPN using Zerotier and a Raspberry Pi
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
       </i><time datetime="2020-05-16T23:00:00+01:00"> Sat 16 May 2020</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://semaj.omg.lol/category/how-to.html">How To</a>


<span class="label label-default">Tags</span>
	<a href="https://semaj.omg.lol/tag/projects.html">Projects</a>
        /
	<a href="https://semaj.omg.lol/tag/networking.html">Networking</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This post aims to document a project that I setup and use every day. It is primarily to help me in the future when I want to set it up again! I hope you find it useful for your own projects.</p>
<p>I run a [Pihole](https://pi-hole.net/) ad blocker on my home network, and it is great. It blocks a ton of crap at the network level including ads, telemetry and other nasties. It stops working when I leave home which isn't great. I used to run an OpenVPN server which was fine but I don't have a static IP. This meant it regularly broke for my wife so I had to find a new solution...</p>
<p>I found a P2P VPN application called Zerotiert hat creates a secure, encrypted virtual LAN (local area network) over the internet.</p>
<p>This means I can connect to my ZeroTier network via the iOS / Android / Windows / iOS apps and effectively be on my home network, therefore the PiHole is available to all my devices as long as they're connected to ZeroTier.</p>
<p>With a bit of routing magic via iptables on the Pi I can direct all my traffic via ZeroTier and out to the internet via my home connection.</p>
<p>To get started, install ZeroTier on the computer you're going to leave on at home all the time. My Pihole was already running on a Pi3, so I used that. Follow their instructions to create your network- Make sure your ZeroTier network used a range that won't clash with your existing networks. Once you have basic connectivity working, we can move on to routing packets.</p>
<p>You'll need to add some routes to your ZeroTier network on my.zerotier.com.</p>
<p>![/images/zt-managed-routes.png](/images/zt-managed-routes.png){:class="img-fluid"}</p>
<p>**0.0.0.0/0** is the default route to the internet, and should point to the ZeroTier IP address belonging to your Pi.</p>
<p>**192.168.1.0/24** is the IP range of my home network, and should point to the ZeroTier IP address belong to the Pi.</p>
<p>**168.168.8.0/24** is the IP range of my travel router (more on that in another post); this route points to the ZeroTier IP address belonging to the router. I have similar forwarding rules setup on this router, which means anything I connect to it such my Nintendo Switch, or Chromecast are automatically tunneled home via Zerotier. I tested this with Netflix and All4 and both worked perfectly when I was working in France earlier in the year</p>
<p>At this point, you should be able to connect to ZeroTier over mobile data and connect to IP addresses in your local network. Try your router's admin interface!</p>
<p>Once the routes are setup, it is time to fiddle with iptables. Honestly, it's best to this connected to the Pi via a serial shell, or just hook up a keyboard/mouse and a screen. You're gonna mess this up at least once and break connectivity ;)</p>
<p>Begin by enabling IP forwarding on the Pi:</p>
<div class="highlight"><pre><span></span><code>sudo sysctl -w net.ipv4.ip_forward=1
</code></pre></div>

<p>Next, create the forwarding rules on the Pi; These enable forwarding between eth0 on the Pi (you are using ethernet and not wifi, right?) and the Zerotier interface.<br>
Replace ZT_INTERFACE with the local ZeroTier interface name - you can get this from ifconfig. In my case, the interface is called ztrtastctq.</p>
<div class="highlight"><pre><span></span><code>sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -i eth0 -o ZT_INTERFACE -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i ZT_INTERFACE -o eth0 -j ACCEPT
</code></pre></div>

<p>Once this is done, you should be able to test again. Your traffic should be reaching the interface via your home connection, so connect via mobile data and see what your [IP address](http://www.whatismyipaddress.com) is.</p>
<p>If this is working, it's time to save the iptables rules so they persist over the next reboot. To do this, run the following commands:</p>
<div class="highlight"><pre><span></span><code>sudo apt install iptables-persistent
sudo iptables-save &gt; /etc/iptables/rules.v4
</code></pre></div>

<p>To forward your traffic over ZeroTier you need to make sure that "Allow Global" is ticked in your ZeroTier client. This will let your traffic flow!</p>
<p>You could also set your primary DNS to be the ZeroTier address of the Pihole so that your DNS queries are funneled via ZeroTier without the rest of your traffic, this can be useful when using less hostile networks that you still want adblocking enabled.</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://semaj.omg.lol/2020/05/16/setup-a-vpn.html">Setup a VPN using Zerotier and a Raspberry Pi</a></li>
        <li><a href="https://semaj.omg.lol/2016/07/raspberry-pi-spotify-jukebox/">Raspberry Pi Spotify Jukebox</a></li>
        <li><a href="https://semaj.omg.lol/2012/01/apple-airport-express-and-the-case-of-the-wrong-region/">Apple Airport Express and the case of the wrong region</a></li>
        <li><a href="https://semaj.omg.lol/2011/08/slingbox-pro-power-supply-issues/">Slingbox Pro Power Supply Issues</a></li>
        <li><a href="https://semaj.omg.lol/2011/07/thoughts-about-pogoplug/">Thoughts about PogoPlug</a></li>
    </ul>
</section>

            <!-- No Comments -->



            





        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="https://semaj.omg.lol/now/2024/w13/index.html">Now - Week 13 of 2024</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/03/kinver-edge-and-the-rock-houses/">Kinver Edge and the Rock Houses</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/03/thoughts-on-activitypub-and-the-fediverse/">Thoughts on ActivityPub and the Fediverse</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/02/visiting-the-highest-waterfall-in-south-wales/">Visiting the Highest Waterfall in South Wales</a></li>
    <li class="list-group-item"><a href="https://semaj.omg.lol/2024/02/moving-the-blog-again/">Moving the blog again</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="https://social.lol/@semaj" target="_blank">Mastodon</a>
    </li>
    <li class="list-group-item">
      <a href="https://ramblingreaders.org/user/Semaj" target="_blank">BookWyrm</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.exophase.com/user/geekyjames/" target="_blank">Exophase</a>
    </li>
    <li class="list-group-item">
      <a href="https://boardgamegeek.com/user/james__" target="_blank">BoardGameGeek </a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 James Leighton
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://semaj.omg.lol/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://semaj.omg.lol/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://semaj.omg.lol/theme/js/respond.min.js"></script>





<script data-goatcounter="https://semaj.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

</body>
</html>